<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AstronomickÃ¡ PÅ™edpovÄ›Ä</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
      padding: 20px;
    }
    h1 {
      font-size: 2.5em;
      text-align: center;
      margin-bottom: 20px;
    }
    .input-section {
      text-align: center;
      margin-bottom: 40px;
      font-size: 1.4em;
    }
    .input-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    input#city {
      width: 250px;
      font-size: 1.1em;
      padding: 12px 16px;
    }
    button#gpsButton {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.8em;
      transition: transform 0.6s ease;
    }
    button#gpsButton svg {
      width: 36px;
      height: 36px;
      fill: #3399ff; /* modrÃ¡ */
      transition: fill 0.3s ease, transform 0.6s ease;
    }
    button#gpsButton:hover svg {
      fill: #66ccff; /* svÄ›tlejÅ¡Ã­ modrÃ¡ pÅ™i hoveru */
      transform: scale(1.2);
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1.2); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1.2); }
    }
    button#forecastButton {
      padding: 12px 16px;
      font-size: 1.1em;
      cursor: pointer;
      margin-top: 10px;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 40px;
      align-items: flex-start;
    }
    .left-column, .right-column {
      display: flex;
      flex-direction: column;
      flex: 1 1 500px;
      max-width: 600px;
    }
    .forecast {
      margin-top: 0;
    }
    .forecast-title {
      font-size: 1.8em;
      font-weight: bold;
      color: #ffd54f;
      margin-bottom: 15px;
    }
    .day {
      background: #222;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
    }
    .day h3 {
      font-size: 1.6em;
      margin-top: 0;
    }
    .day p {
      font-size: 1.1em;
      margin: 6px 0;
      background: #333;
      padding: 8px 10px;
      border-radius: 6px;
    }
    .highlight {
      background-color: #2e7d32 !important;
      color: #b9f6ca;
      font-weight: bold;
    }
    .seeing-result {
      font-weight: bold;
    }
    .seeing-ideal { color: #66ff66; }
    .seeing-average { color: #ffcc66; }
    .seeing-bad { color: #ff6666; }
    img.icon {
      vertical-align: middle;
      height: 40px;
    }
    #map {
      width: 70%;
      height: 315px;
      border-radius: 8px;
      margin-bottom: 20px;
      align-self: center;
    }
    @media (max-width: 768px) {
      #map {
        width: 100%;
        height: 250px;
      }
      .input-section {
        font-size: 1.2em;
      }
      .input-row {
        flex-direction: column;
      }
      input, button {
        width: 90%;
        font-size: 1em;
      }
      h1 {
        font-size: 2em;
      }
    }
  </style>
</head>
<body>

<h1>ğŸŒ  AstronomickÃ¡ PÅ™edpovÄ›Ä</h1>

<div class="input-section">
  <label for="city">Zadejte mÄ›sto:</label><br>
  <div class="input-row">
    <input type="text" id="city" placeholder="napÅ™. Praha">
    <button id="gpsButton" title="PouÅ¾Ã­t mou polohu">
      <!-- SVG ikona mÃ­sto emoji ğŸ“ -->
      <svg viewBox="0 0 24 24">
        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5 14.5 7.62 14.5 9 13.38 11.5 12 11.5z"/>
      </svg>
    </button>
  </div>
  <button id="forecastButton">Zobrazit</button>
</div>

<div class="container">
  <div class="left-column">
    <div id="forecast" class="forecast"></div>
  </div>
  <div class="right-column">
    <div id="map"></div>
  </div>
</div>

<div style="text-align:center; margin-top: 60px;">
  <p style="margin-bottom: 10px; font-size: 1.1em;">ğŸ’– PodpoÅ™ vÃ½voj tÃ©to aplikace</p>
  <a href="https://www.buymeacoffee.com/TVOJENICK" target="_blank">
    <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="PodpoÅ™ mÄ›" style="height: 50px; width: 210px;">
  </a>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const weatherApiKey = "365461721d8f9f7caa7c1460f8181f3d";
const moonApiKey = "781aa2d69af74745906e01cc68c84207";
let map, sunMarker, cachedClouds = null;
let astronomicalTwilight = { begin: "", end: "" };

function seeingQuality(clouds) {
  if (clouds < 15) return { label: "VÃ½jimeÄnÄ› ideÃ¡lnÃ­ podmÃ­nky ğŸŒŒ", class: "seeing-ideal" };
  if (clouds < 50) return { label: "PrÅ¯mÄ›rnÃ© podmÃ­nky â›…ï¸", class: "seeing-average" };
  return { label: "NevhodnÃ© pro pozorovÃ¡nÃ­ â˜ï¸", class: "seeing-bad" };
}

async function getCoordinates() {
  const city = document.getElementById("city").value.trim();
  if (!city) return alert("Zadej nÃ¡zev mÄ›sta!");
  try {
    const res = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${city}&limit=1&appid=${weatherApiKey}`);
    const data = await res.json();
    if (!data[0]) return alert("MÄ›sto nenalezeno");
    const { lat, lon, name } = data[0];
    loadWeather(lat, lon, name);
    getMoonPhase(lat, lon);
    showMap(lat, lon);
  } catch (error) {
    alert("Chyba pÅ™i zÃ­skÃ¡vÃ¡nÃ­ souÅ™adnic.");
    console.error(error);
  }
}

async function loadWeather(lat, lon, name) {
  try {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${weatherApiKey}&units=metric&lang=cz`);
    const data = await res.json();
    const weather = data.weather[0].description;
    const icon = data.weather[0].icon;
    const temperature = data.main.temp;
    const clouds = data.clouds.all;
    cachedClouds = clouds;
    const seeing = seeingQuality(clouds);
    const sunrise = new Date(data.sys.sunrise * 1000).toLocaleTimeString("cs-CZ", { hour: '2-digit', minute: '2-digit' });
    const sunset = new Date(data.sys.sunset * 1000).toLocaleTimeString("cs-CZ", { hour: '2-digit', minute: '2-digit' });
    const forecastEl = document.getElementById("forecast");
    forecastEl.innerHTML = `
      <div class="day">
        <div class="forecast-title">PÅ™edpovÄ›Ä pro ${name}</div>
        <h3>ğŸŒ€ AktuÃ¡lnÃ­ poÄasÃ­</h3>
        <p>ğŸŒ¤ï¸ <strong>PoÄasÃ­:</strong> ${weather} <img class="icon" src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="${weather}"></p>
        <p>ğŸŒ¡ï¸ <strong>Teplota:</strong> ${temperature}Â°C</p>
        <p>â˜ï¸ <strong>OblaÄnost:</strong> ${clouds}%</p>
      </div>
      <div id="seeingBlock" class="day">
        <h3>ğŸ”­ Seeing</h3>
        <p class="seeing-result ${seeing.class}">ğŸ‘ï¸ <strong>${seeing.label}</strong></p>
      </div>
      <div class="day">
        <h3>â˜€ï¸ Slunce</h3>
        <p>ğŸŒ… <strong>VÃ½chod slunce:</strong> ${sunrise}</p>
        <p>ğŸŒ‡ <strong>ZÃ¡pad slunce:</strong> ${sunset}</p>
        <p>ğŸ”— <strong>ZaÄÃ¡tek tmy:</strong> ${astronomicalTwilight.end}</p>
        <p>ğŸŒ… <strong>Konec tmy:</strong> ${astronomicalTwilight.begin}</p>
      </div>
      <div class="day">
        <h3>ğŸŒ• MÄ›sÃ­c</h3>
        <div id="moonInfo"></div>
      </div>`;
  } catch (error) {
    alert("Chyba pÅ™i naÄÃ­tÃ¡nÃ­ poÄasÃ­.");
    console.error(error);
  }
}

async function getMoonPhase(lat, lon) {
  try {
    const res = await fetch(`https://api.ipgeolocation.io/astronomy?apiKey=${moonApiKey}&lat=${lat}&long=${lon}`);
    const data = await res.json();
    astronomicalTwilight.begin = data.astronomical_twilight_begin;
    astronomicalTwilight.end = data.astronomical_twilight_end;
    const moonInfo = document.getElementById("moonInfo");
    moonInfo.innerHTML = `
      <p>ğŸŒ˜ <strong>FÃ¡ze MÄ›sÃ­ce:</strong> ${data.moon_phase}</p>
      <p>ğŸ’¡ <strong>OsvÄ›tlenÃ­ MÄ›sÃ­ce:</strong> ${data.moon_illumination_percentage} %</p>
      <p>ğŸ“ <strong>VzdÃ¡lenost od ZemÄ›:</strong> ${data.moon_distance} km</p>
      <p>ğŸŒ™ <strong>VÃ½chod MÄ›sÃ­ce:</strong> ${data.moonrise}</p>
      <p>ğŸŒ’ <strong>ZÃ¡pad MÄ›sÃ­ce:</strong> ${data.moonset}</p>`;
  } catch (error) {
    console.error("Chyba pÅ™i naÄÃ­tÃ¡nÃ­ MÄ›sÃ­ce:", error);
  }
}

function showMap(lat, lon) {
  if (!map) {
    map = L.map("map").setView([lat, lon], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap pÅ™ispÄ›vatele',
      maxZoom: 19,
    }).addTo(map);
    sunMarker = L.marker([lat, lon]).addTo(map).bindPopup("Tvoje poloha");
  } else {
    map.setView([lat, lon], 10);
    sunMarker.setLatLng([lat, lon]);
  }
}

document.getElementById("forecastButton").addEventListener("click", getCoordinates);

document.getElementById("gpsButton").addEventListener("click", () => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async position => {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
        const data = await res.json();
        if (data.address && data.address.city) {
          document.getElementById("city").value = data.address.city;
        } else if (data.address && data.address.town) {
          document.getElementById("city").value = data.address.town;
        } else if (data.address && data.address.village) {
          document.getElementById("city").value = data.address.village;
        } else {
          document.getElementById("city").value = `${lat},${lon}`;
        }
      } catch (error) {
        alert("Chyba pÅ™i zÃ­skÃ¡vÃ¡nÃ­ nÃ¡zvu mÃ­sta.");
        console.error(error);
      }
    }, () => {
      alert("NepodaÅ™ilo se zÃ­skat polohu.");
    });
  } else {
    alert("Geolokace nenÃ­ podporovÃ¡na tÃ­mto prohlÃ­Å¾eÄem.");
  }
});
</script>

</body>
</html>
